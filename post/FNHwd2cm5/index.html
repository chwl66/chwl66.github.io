<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" >

<title>WordPress编辑器中添加“上传到Chevereto图床”按钮 | 温故知新</title>
<meta name="description" content="温故而知新">

<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">

<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.7.2/css/all.css" integrity="sha384-fnmOCqbTlWIlj8LyTjo7mOUStjsKC4pOpQbqyi7RrhN7udi9RwhKkMHpvLbHG9Sr" crossorigin="anonymous">
<link rel="shortcut icon" href="https://chwl66.github.io/favicon.ico?v=1576324428641">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/katex.min.css">
<link rel="stylesheet" href="https://chwl66.github.io/styles/main.css">


  

  
    <link rel="stylesheet" href="https://unpkg.com/disqusjs@1.1/dist/disqusjs.css" />
  


<script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
<script src="https://cdn.bootcss.com/highlight.js/9.12.0/highlight.min.js"></script>

<link rel="stylesheet" href="https://unpkg.com/aos@next/dist/aos.css" />



  </head>
  <body>
    <div id="app" class="main">

      <div class="sidebar" :class="{ 'full-height': menuVisible }">
  <div class="top-container" data-aos="fade-right">
    <div class="top-header-container">
      <a class="site-title-container" href="https://chwl66.github.io">
        <img src="https://chwl66.github.io/images/avatar.png?v=1576324428641" class="site-logo">
        <h1 class="site-title">温故知新</h1>
      </a>
      <div class="menu-btn" @click="menuVisible = !menuVisible">
        <div class="line"></div>
      </div>
    </div>
    <div>
      
        
          <a href="/" class="site-nav">
            首页
          </a>
        
      
        
          <a href="/archives" class="site-nav">
            归档
          </a>
        
      
        
          <a href="/tags" class="site-nav">
            标签
          </a>
        
      
        
          <a href="/post/about" class="site-nav">
            关于
          </a>
        
      
    </div>
  </div>
  <div class="bottom-container" data-aos="flip-up" data-aos-offset="0">
    <div class="social-container">
      
        
      
        
      
        
      
        
      
        
      
    </div>
    <div class="site-description">
      温故而知新
    </div>
    <div class="site-footer">
      Powered by <a href="https://github.com/getgridea/gridea" target="_blank">Gridea</a> | <a class="rss" href="https://chwl66.github.io/atom.xml" target="_blank">RSS</a>
    </div>
  </div>
</div>


      <div class="main-container">
        <div class="content-container" data-aos="fade-up">
          <div class="post-detail">
            <h2 class="post-title">WordPress编辑器中添加“上传到Chevereto图床”按钮</h2>
            <div class="post-date">2019-12-01</div>
            
              <div class="feature-container" style="background-image: url('https://s2.ax1x.com/2019/12/01/Qmrvq0.png')">
              </div>
            
            <div class="post-content">
              <p>前段时间搭建了 Chevereto 图床，但在 WordPress 编辑器里需要上传图片的时候，需要另外打开图床上传比较麻烦。这时候可以在 WordPress 的编辑器里添加个上传按钮，利用 API 上传到 Chevereto 图床，这样上传图片到图床就方便啦！</p>
<figure data-type="image" tabindex="1"><img src="https://s2.ax1x.com/2019/12/01/Qmrvq0.png" alt="Qmrvq0.png"></figure>
<p>下面我把详细啊方法记录一下：</p>
<h3 id="chevereto">Chevereto</h3>
<p>获取 API KEY: 登录，转到 <code>仪表盘-设置-API</code>，将  <code>API v1 key</code>  记录下来;</p>
<p>API 后端设置: 进入 Chevereto 的安装目录，将 <code>app/routes/route.api.php</code> 文件拷贝到 <code>app/routes/overrides/route.api.php</code> 文件;</p>
<p>允许跨域: 打开 <code>app/routes/overrides/route.api.php</code>，添加</p>
<pre><code>header('Access-Control-Allow-Origin: https://spiritx.xyz');
header('Access-Control-Allow-Methods: POST');
header('Access-Control-Allow-Headers: Content-Type, Accept, Authorization, X-Requested-With, Origin, Accept');
</code></pre>
<p>记得把白名单 <code>https://spiritx.xyz</code> 改成自己的域名或者改成* （所有域名可用）；</p>
<p>设置 API user(可选): 在 <code>app/routes/overrides/route.api.php</code> 中，找到<code>$uploaded_id = CHV\Image::uploadToWebsite($source);</code>那一行，更改为</p>
<pre><code>$uploaded_id = CHV\Image::uploadToWebsite($source,admin);
</code></pre>
<p>将 admin 替换为图床中的用户;</p>
<h3 id="wordpress-53版本以下用">WordPress 5.3版本以下用</h3>
<p>前端添加上传按钮(media button)： 将以下代码添加到<a href="https://www.yunloc.com/tag/wordpress">WordPress</a>正在使用的主题目录的 functions.php 中</p>
<pre><code>//添加图床上传按钮
add_action('media_buttons', 'add_my_media_button');
function add_my_media_button() {
    $currentUser = wp_get_current_user();
        if(!empty($currentUser-&gt;roles) &amp;&amp; in_array('administrator', $currentUser-&gt;roles)){
            $DOMAIN=&quot;图床的域名&quot;;
            $APIkey=&quot;图床的API v1 key&quot;;// 是管理员
        }
        else
            return 0;  // 非管理员
    echo '
            &lt;input id=&quot;up_to_chevereto&quot; type=&quot;file&quot; accept=&quot;image/*&quot; multiple=&quot;multiple&quot;/&gt;
            &lt;label for=&quot;up_to_chevereto&quot; id=&quot;up_img_label&quot;&gt;&lt;i class=&quot;fa fa-picture-o&quot; aria-hidden=&quot;true&quot;&gt;&lt;/i&gt; 上传图片到Chevereto&lt;/label&gt;
          ';
?&gt;
&lt;style type=&quot;text/css&quot;&gt;
#up_to_chevereto {
  display: none;
}
#up_img_label {
  color: #fff;
  background-color: #16a085;
  border-radius: 5px;
  display: inline-block;
  padding: 5.2px;
}
&lt;/style&gt;
&lt;script type=&quot;text/javascript&quot;&gt;
$('#up_to_chevereto').change(function() {
  window.wpActiveEditor = null;
  for (var i = 0; i &lt; this.files.length; i++) {
    var f=this.files[i];
    var formData=new FormData();
    formData.append('source',f);
    $.ajax({
        async:true,
        crossDomain:true,
        url:'https://&lt;?php echo $DOMAIN; ?&gt;/api/1/upload/?key=&lt;?php echo $APIkey; ?&gt;&amp;format=json',
        type : 'POST',
        processData : false,
        contentType : false,
        data:formData,
        beforeSend: function (xhr) {
            $('#up_img_label').html('&lt;i class=&quot;fa fa-spinner rotating&quot; aria-hidden=&quot;true&quot;&gt;&lt;/i&gt; Uploading...');
        },
        success:function(res){
            wp.media.editor.insert('&lt;a href='+res.image.url+'&gt;&lt;img src='+res.image.url+' alt='+res.image.title+'&gt;&lt;/img&gt;&lt;/a&gt;');
            $(&quot;#up_img_label&quot;).html('&lt;i class=&quot;fa fa-check&quot; aria-hidden=&quot;true&quot;&gt;&lt;/i&gt; 上传成功,继续上传');
        },
        error: function (){
            $(&quot;#up_img_label&quot;).html('&lt;i class=&quot;fa fa-times&quot; aria-hidden=&quot;true&quot;&gt;&lt;/i&gt; 上传失败，重新上传');
        }
    });
  }
});
&lt;/script&gt;
&lt;?php
}
</code></pre>
<h3 id="wordpress-53版本用">WordPress 5.3版本用</h3>
<pre><code>//添加图床上传按钮
add_action('media_buttons', 'add_my_media_button');
function add_my_media_button() {
    $currentUser = wp_get_current_user();
        if(!empty($currentUser-&gt;roles) &amp;&amp; in_array('administrator', $currentUser-&gt;roles)){
            $DOMAIN=&quot;图床的域名&quot;;
            $APIkey=&quot;图床的API v1 key&quot;;// 是管理员
        }
        else
            return 0;  // 非管理员
    echo '
            &lt;input id=&quot;up_to_chevereto&quot; type=&quot;file&quot; accept=&quot;image/*&quot; multiple=&quot;multiple&quot;/&gt;
            &lt;label for=&quot;up_to_chevereto&quot; id=&quot;up_img_label&quot;&gt;&lt;i class=&quot;fa fa-picture-o&quot; aria-hidden=&quot;true&quot;&gt;&lt;/i&gt; 上传图片到Chevereto&lt;/label&gt;
          ';
?&gt;
&lt;style type=&quot;text/css&quot;&gt;
#up_to_chevereto {
  display: none;
}
#up_img_label {
  color: #fff;
  background-color: #16a085;
  border-radius: 5px;
  display: inline-block;
  padding: 5.2px;
}
&lt;/style&gt;
&lt;script type=&quot;text/javascript&quot;&gt;
jQuery('#up_to_chevereto').change(function() {
  window.wpActiveEditor = null;
  for (var i = 0; i &lt; this.files.length; i++) {
    var f=this.files[i];
    var formData=new FormData();
    formData.append('source',f);
    jQuery.ajax({
        async:true,
        crossDomain:true,
        url:'https://&lt;?php echo $DOMAIN; ?&gt;/api/1/upload/?key=&lt;?php echo $APIkey; ?&gt;&amp;format=json',
        type : 'POST',
        processData : false,
        contentType : false,
        data:formData,
        beforeSend: function (xhr) {
            jQuery('#up_img_label').html('&lt;i class=&quot;fa fa-spinner rotating&quot; aria-hidden=&quot;true&quot;&gt;&lt;/i&gt; Uploading...');
        },
        success:function(res){
            wp.media.editor.insert('&lt;a href='+res.image.url+'&gt;&lt;img src='+res.image.url+' alt='+res.image.title+'&gt;&lt;/img&gt;&lt;/a&gt;');
            jQuery(&quot;#up_img_label&quot;).html('&lt;i class=&quot;fa fa-check&quot; aria-hidden=&quot;true&quot;&gt;&lt;/i&gt; 上传成功,继续上传');
        },
        error: function (){
            jQuery(&quot;#up_img_label&quot;).html('&lt;i class=&quot;fa fa-times&quot; aria-hidden=&quot;true&quot;&gt;&lt;/i&gt; 上传失败，重新上传');
        }
    });
  }
});
&lt;/script&gt;
&lt;?php
}
</code></pre>
<p>style里的样式可以根据自己偏好自定义</p>
<h3 id="使用预览">使用预览</h3>
<p>这里我的编辑器用的是WP Editor.md，界面不同但不影响上传按钮的使用</p>
<figure data-type="image" tabindex="2"><img src="https://s2.ax1x.com/2019/12/01/QmrzZV.gif" alt="QmrzZV.gif"></figure>
<h4 id="文章引用至-spirit的小站-转载请注明出处">文章引用至 <a href="https://spiritx.xyz/843.html">spirit的小站</a> 转载请注明出处！</h4>

            </div>
            
            
              <div class="next-post">
                <div class="next">下一篇</div>
                <a href="https://chwl66.github.io/post/Y80xYA7z9">
                  <h3 class="post-title">
                    typecho在后台增加图床上传图片按钮
                  </h3>
                </a>
              </div>
            

            
              

              
                <div id="disqus_thread" data-aos="fade-in"></div>
              
            

          </div>

        </div>
      </div>
    </div>

    <script src="https://unpkg.com/aos@next/dist/aos.js"></script>

<script type="application/javascript">

AOS.init();

hljs.initHighlightingOnLoad()

var app = new Vue({
  el: '#app',
  data: {
    menuVisible: false,
  },
})

</script>



  

  
    <script src="https://unpkg.com/disqusjs@1.1/dist/disqus.js"></script>
    <script>

    var options = {
      shortname: 'gridea',
      apikey: 'WInTbn2XH8Lt3PHZgEDKgsag5dk7tsBGpznE0MNeBQFTwrvD05gnXtF9UUjsqwSp',
    }
    if ('') {
      options.api = ''
    }
    var dsqjs = new DisqusJS(options)

    </script>
  




  </body>
</html>
